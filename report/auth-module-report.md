# Отчёт о модуле авторизации SkillSwap

## 1. Постановка задачи
До начала работы в SkillSwap не было связки между интерфейсом и настоящим сервером. Пользователь «авторизовывался» через локальное хранилище, а данные никуда не сохранялись. Цель — построить полноценный цикл регистрации и входа:
- реализовать backend с БД и API, который умеет регистрировать, логинить, обновлять сессию и разлогинивать пользователя;
- переписать фронтенд так, чтобы он общался с сервером, не хранил токены в `localStorage` и закрывал приватные страницы от гостей;
- оставить удобный UX: многошаговая регистрация, автоматическое восстановление сессии и понятные ошибки.

Ключевое требование — использовать реальные данные (token, пользователь, refresh) и обеспечить безопасность (bcrypt, JWT, HTTP-only cookies).

## 2. Выбор технологий и почему именно они
### Сервер и язык
- **Node.js 20** — современная LTS-версия, которую легко поднять на любом окружении.
- **Express 5** — минималистичный фреймворк со всем необходимым: роутинг, middleware, подключение CORS и cookie-parser. На нём удобно быстро собирать REST, а проект остаётся простым для защиты.

### Работа с БД
- **Prisma ORM** — типобезопасный доступ к данным и миграции «из коробки». Код получился читабельным, а типы автоматически попадают в TypeScript.
- **SQLite** — достаточно для учебного проекта: никакой внешней инфраструктуры, база — обычный файл. При переходе в прод можно сменить строку подключения на PostgreSQL и прогнать миграции.

### Безопасность и авторизация
- **bcryptjs** — проверенный алгоритм хеширования, задаём количество раундов и храним в базе только хэши.
- **jsonwebtoken** — стандартная библиотека для работы с JWT; используем access и refresh токены.
- **cookie-parser** и **HTTP-only cookie** — refresh токен хранится в защищённой cookie, к которой не доберётся JS. Это защищает от XSS и удобно для автоматического обновления сессии.

### Валидация и настройки
- **zod** — одна библиотека для валидации входящих запросов (login/register) и конфигурации (`.env`). Ошибки возвращаются в удобном формате, что облегчает обработку на фронте.

### Фронтенд
- **React 19 + React Router 7** — основной стек проекта, поэтому сохраняем единый подход. Используем контекст авторизации и защищённые маршруты.
- **Fetch-обёртка** — отдельный модуль `request.ts` добавляет `credentials: 'include'`, автоматически сериализует JSON и приводит ошибки к формату `ApiError`.
- **TypeScript + Vite** — базовые инструменты SkillSwap. TypeScript держит в тонусе как frontend, так и backend, а Vite обеспечивает быстрый hot reload, что помогает тестировать многошаговые формы.

## 3. Структура и ответственность файлов
Ниже перечислены ключевые элементы модуля.

### Backend
1. **`backend/src/app.ts`** — создаёт приложение Express, подключает ч (со списком разрешённых origin), cookie-parser, JSON, ставит маршруты `/api/auth` и обработчик ошибок.
2. **`backend/src/server.ts`** — точка входа, запускает HTTP-сервер на порту из конфигурации.
3. **`backend/src/config/env.ts`** — считывает `.env`, валидирует через zod, нормализует список CORS-origin и параметры JWT.
4. **`backend/src/lib/prisma.ts`** — инициализирует единый экземпляр PrismaClient, чтобы переиспользовать соединение.
5. **`backend/src/repositories/userRepository.ts`** — вся работа с базой: поиск и создание пользователя, сохранение refresh-токена, удаление токена (через `deleteMany`, чтобы защититься от гонок).
6. **`backend/src/services/password.ts`** — обёртки вокруг bcrypt: хеширование пароля и проверка.
7. **`backend/src/services/tokenService.ts`** — генерация и проверка access/refresh JWT, вычисление сроков жизни.
8. **`backend/src/services/authService.ts`** — бизнес-логика: регистрация, вход, выдача новых токенов, ревокация refresh. Здесь же удаляем старый токен и создаём новый.
9. **`backend/src/controllers/authController.ts`** — HTTP-слой: валидирует входные данные, отвечает клиенту, выставляет и очищает refresh-cookie.
10. **`backend/src/routes/auth.ts`** — собирает единую точку `/api/auth`, навешивает `authenticateAccessToken` на `GET /me`.
11. **`backend/src/middleware/authenticateAccessToken.ts`** — проверяет `Authorization: Bearer`, раскладывает payload в `req.user`, иначе — 401.
12. **`backend/src/middleware/errorHandler.ts`** — единая обработка ошибок: кастомные `HttpError` и fallback на 500.
13. **`backend/scripts/init-db.ts`** — SQL-скрипт для начальной инициализации таблиц (если Prisma migrate недоступен).
14. **`backend/prisma/schema.prisma`** — описывает модели `User` и `RefreshToken`.
15. **`backend/prisma/migrations/0001_init/migration.sql`** — SQL миграция, используемая в `db:init`.

### Frontend
16. **`src/shared/api/request.ts`** — единая функция `request`, работает с cookies, автоматически превращает ответы в JSON и поднимает `ApiError`.
17. **`src/shared/api/auth.ts`** — конкретные вызовы API (`login`, `register`, `refresh`, `logout`, `me`) с описанием типов.
18. **`src/app/providers/auth/context.ts`** — структура данных для AuthContext: пользователь, access-токен, методы `login`, `register`, `logout`, `refresh`, флаг `isInitializing`.
19. **`src/app/providers/auth/AuthProvider.tsx`** — ядро фронтовой авторизации: хранит состояние сессии, вызывает authApi, делает авто-`refresh` при монтировании и чистит данные при `logout`.
20. **`src/shared/lib/ProtectedRoute/ProtectedRoute.tsx`** — компонент-обёртка: если пользователь не авторизован, перенаправляет на `/login`, иначе рендерит контент.
21. **`src/pages/Auth/ui/AuthStepOne.tsx`** — шаг 1: вход для существующих пользователей и сохранение email/пароля в `sessionStorage` перед регистрацией.
22. **`src/pages/Auth/ui/AuthStepTwo.tsx`** — шаг 2: собирает доп. данные (имя, город, навыки), валидирует наличие Step 1, сохраняет промежуточную форму.
23. **`src/pages/Auth/ui/AuthStepThree.tsx`** — шаг 3: итоговая проверка и отправка на backend `register`, показывает превью, ошибки, чистит `sessionStorage`.
24. **`src/widgets/Header/ui/Header.tsx`** — отображает имя авторизованного пользователя; если пользователь гость, предлагает перейти на логин/регистрацию.

## 4. Выводы и что показывать на защите
Мы построили полный цикл авторизации:
- данные пользователей и токены живут в реальной базе;
- пароли хранятся в виде bcrypt-хэшей;
- refresh-токен сидит в защищённой cookie, access-токен — только в памяти;
- защищённые маршруты (профиль) закрыты для гостей;
- трёхшаговая регистрация сохраняет промежуточные данные и соединена с backend.

Для демонстрации:
1. Запустить backend: `cd backend && npm run db:init && npm run dev`.
2. Запустить frontend: `npm run dev` (адрес будет `http://localhost:4001`).
3. Пройти регистрацию (3 шага), показать, что главный экран «видит» пользователя и `/api/auth/me` даёт данные.
4. Перезагрузить страницу — сессия подтянется автоматически.
5. Выполнить `logout`, убедиться, что `/me` редиректит на `/login`.

К вопросам готовимся по следующим блокам:
- как устроена схема Prisma и какие поля у `User`/`RefreshToken`;
- почему выбраны bcrypt и JWT, как храним токены;
- как работает `AuthProvider` и почему токен не лежит в `localStorage`;
- что делает `ProtectedRoute` и как она связана со `StrictMode`.

Проект готов к показу, код чистый, структуры подписаны — остаётся потренироваться в устном объяснении.
